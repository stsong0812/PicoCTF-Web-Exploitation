# PicoCTF Web Exploitation: 41-44

## 41. SQLiLite

\--------------------------------------UNDER MAINTENANCE---------------------------------------

## 42. Java Code Analysis!?!

<details>

<summary>Provided Hints:</summary>

(None)

</details>

**Description:** BookShelf Pico, my premium online book-reading service.I believe that my website is super secure. I challenge you to prove me wrong by reading the 'Flag' book!

Additional details will be available after launching your challenge instance.

**Writeup:** Launch the instance, download the source files and visit the website. We are given a login with the username and password as "user". There seems to be three available books to us, but only one we can access.&#x20;

<figure><img src=".gitbook/assets/Screenshot_2023-06-10_11_05_07.png" alt=""><figcaption></figcaption></figure>

Looking through the source files, these files and code blocks seem useful.

```
FILE: UserService.java

@PreAuthorize("hasAuthority('Admin')")
    public List<UserDto> getAllUsers() {
        return UserDto.getUserDtoListFromUsers(userRepository.findAll());
    }

    //returns a JWT if success
    public String login(UserLoginRequest userLoginRequest)...
```

We know we need "Admin" authorization, furthermore, it looks like a JWT token is returned upon successful login.

```
FILE: JwtService.java

    private static final String CLAIM_KEY_USER_ID = "userId";
    private static final String CLAIM_KEY_EMAIL = "email";
    private static final String CLAIM_KEY_ROLE = "role";
    private static final String ISSUER = "bookshelf";
    
    @Autowired
    public JwtService(SecretGenerator secretGenerator){
        this.SECRET_KEY = secretGenerator.getServerSecret();
    }

public String createToken(Integer userId, String email, String role){
        Algorithm algorithm = Algorithm.HMAC256(SECRET_KEY);

        Calendar expiration = Calendar.getInstance();
        expiration.add(Calendar.DATE, 7); //expires after 7 days

        return JWT.create()
                .withIssuer(ISSUER)
                .withIssuedAt(new Date())
                .withExpiresAt(expiration.getTime())
                .withClaim(CLAIM_KEY_USER_ID, userId)
                .withClaim(CLAIM_KEY_EMAIL, email)
                .withClaim(CLAIM_KEY_ROLE, role)
                .sign(algorithm);
    }
```

These code blocks give us the structure and how the JWT is created. A "secretGenerator" class is also referenced here which we will probably need in decoding our JWT token.

```
FILE: SecurityGenerator.java

@Service
class SecretGenerator {
    private Logger logger = LoggerFactory.getLogger(SecretGenerator.class);
    private static final String SERVER_SECRET_FILENAME = "server_secret.txt";

    @Autowired
    private UserDataPaths userDataPaths;

    private String generateRandomString(int len) {
        // not so random
        return "1234";
    }
```

Here we see the private class "generateRandomString" within the secretgenerator class that tells us our key is not so random, being "1234".

With this information, we have enough clues to decode and alter our JWT token in order to gain admin access. Still logged in as user, we can find our cookie under "Local Storage" in the Applications tab.&#x20;

<figure><img src=".gitbook/assets/Screenshot_2023-06-10_11_15_43.png" alt=""><figcaption></figcaption></figure>

Copy the cookie and paste it into&#x20;
